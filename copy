const express = require('express');
const router = express.Router();
const supabase = require('../supabaseClient');

// إنشاء مستخدم جديد في supabase auth ثم إضافة وكالة جديدة
// body: { email, password, name, wilaya, license_number, phone, bank_account, logo_url, background_url, location_name, latitude, longitude }
router.post('/add', async (req, res) => {
  const { email, password, name, wilaya, license_number, phone, bank_account, logo_url, background_url, location_name, latitude, longitude } = req.body;
  if (!email || !password || !name || !wilaya || !license_number || !phone || !location_name || !latitude || !longitude) {
    return res.status(400).json({ error: 'يرجى إدخال جميع البيانات المطلوبة.' });
  }
  // إنشاء مستخدم جديد في supabase auth
  const { data: userData, error: signUpError } = await supabase.auth.admin.createUser({
    email,
    password,
    email_confirm: true
  });
  if (signUpError) {
    return res.status(500).json({ error: signUpError.message });
  }
  const user = userData.user;
  // إضافة الوكالة في جدول agencies
  const { data, error } = await supabase.from('agencies').insert([
    {
      id: user.id,
      name,
      wilaya,
      license_number,
      phone,
      bank_account,
      logo_url,
      background_url,
      location_name,
      latitude,
      longitude
    }
  ]).select();
  if (error) {
    return res.status(500).json({ error: error.message });
  }
  res.json({ message: 'تم إنشاء الوكالة والمستخدم بنجاح', data });
});

// استرجاع جميع الوكالات
router.get('/all', async (req, res) => {
  const { data, error } = await supabase.from('agencies').select('*');
  if (error) {
    return res.status(500).json({ error: error.message });
  }
  res.json({ agencies: data });
});

module.exports = router;
